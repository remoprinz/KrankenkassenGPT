# üöÄ DEPLOYMENT-ANLEITUNG

**Swiss Health Insurance Premium API**  
Version: 2.2.0

---

## üìã Voraussetzungen

- ‚úÖ Node.js 20+ installiert
- ‚úÖ Firebase CLI installiert (`npm install -g firebase-tools`)
- ‚úÖ Supabase Account mit Projekt
- ‚úÖ ChatGPT Plus Account (f√ºr Custom GPT)

---

## 1Ô∏è‚É£ ERSTE SCHRITTE

### 1.1 Repository klonen & Dependencies installieren

```bash
cd /pfad/zum/projekt
npm install
cd functions
npm install
cd ..
```

### 1.2 Umgebungsvariablen konfigurieren

Erstellen Sie `.env` im Projekt-Root:

```env
# Supabase (von Supabase Dashboard)
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# API Key (selbst generieren)
API_KEY=Ihr-Geheimer-API-Key-Hier
```

**Wichtig:** Generieren Sie einen sicheren API-Key, z.B. mit:
```bash
openssl rand -base64 32
```

Erstellen Sie auch `functions/.env` (gleicher Inhalt wie `.env`).

---

## 2Ô∏è‚É£ DATENBANK SETUP

### 2.1 Supabase Tabellen erstellen

Im Supabase SQL Editor ausf√ºhren:

```sql
-- Premiums Tabelle
CREATE TABLE IF NOT EXISTS premiums (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  year INTEGER NOT NULL,
  insurer_id TEXT NOT NULL,
  canton TEXT NOT NULL,
  region_code TEXT NOT NULL,
  age_band TEXT NOT NULL CHECK (age_band IN ('child', 'young_adult', 'adult')),
  franchise_chf INTEGER NOT NULL CHECK (franchise_chf IN (0, 100, 200, 300, 400, 500, 600, 1000, 1500, 2000, 2500)),
  accident_covered BOOLEAN NOT NULL,
  model_type TEXT NOT NULL CHECK (model_type IN ('standard', 'hmo', 'telmed', 'family_doctor', 'diverse')),
  monthly_premium_chf NUMERIC NOT NULL,
  tariff_name TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Unique Constraint
ALTER TABLE premiums
ADD CONSTRAINT premiums_unique_all
UNIQUE (year, insurer_id, canton, region_code, age_band, franchise_chf, accident_covered, model_type);

-- Indizes f√ºr Performance
CREATE INDEX IF NOT EXISTS idx_premiums_year ON premiums(year);
CREATE INDEX IF NOT EXISTS idx_premiums_insurer ON premiums(insurer_id);
CREATE INDEX IF NOT EXISTS idx_premiums_canton ON premiums(canton);
CREATE INDEX IF NOT EXISTS idx_premiums_lookup ON premiums(year, canton, age_band, franchise_chf, model_type);
```

```sql
-- Locations Tabelle (aus scripts/create_locations.sql)
CREATE TABLE IF NOT EXISTS locations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  zip_code TEXT NOT NULL,
  city TEXT NOT NULL,
  canton TEXT NOT NULL,
  region_code TEXT NOT NULL,
  bfs_number INTEGER
);

CREATE INDEX IF NOT EXISTS idx_locations_zip ON locations(zip_code);
CREATE INDEX IF NOT EXISTS idx_locations_city ON locations(city);
CREATE INDEX IF NOT EXISTS idx_locations_canton ON locations(canton);
```

```sql
-- Insurers Tabelle (optional, f√ºr Namen)
CREATE TABLE IF NOT EXISTS insurers (
  insurer_id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  short_name TEXT,
  website TEXT
);
```

### 2.2 PLZ-Datenbank bef√ºllen

```bash
npx tsx scripts/create-complete-plz.ts
```

**Resultat:** 4,226 Postleitzahlen in `locations` Tabelle

---

## 3Ô∏è‚É£ DATEN IMPORTIEREN

### 3.1 BAG-Daten herunterladen

```bash
# Aktuelle Daten (2026)
npx tsx scripts/download-bag-data.ts

# Historische Daten (2016-2025)
npx tsx scripts/download-historical-data.ts
```

**Speicherort:** `data/` und `data/historical/JAHR/`

### 3.2 Daten transformieren

```bash
# Historische Jahre transformieren (2016-2025)
npx tsx scripts/transform-complete.ts

# 2026 transformieren
npx tsx scripts/transform-2026.ts
```

**Output:** `data/transformed/premiums_JAHR.json`

**Dauer:** ~2-3 Minuten pro Jahr

### 3.3 In Datenbank importieren

```bash
npx tsx scripts/import-complete-all.ts
```

**Dauer:** ~20-25 Minuten f√ºr alle Jahre

**Resultat:**
- 1,611,386 Pr√§mien-Eintr√§ge
- 51 Versicherer
- Jahre 2016-2026

---

## 4Ô∏è‚É£ FIREBASE FUNCTIONS DEPLOYEN

### 4.1 Firebase einrichten

```bash
firebase login
firebase use --add
# W√§hlen Sie Ihr Projekt
```

### 4.2 Functions bauen und deployen

```bash
cd functions
npm run build
cd ..
firebase deploy --only functions
```

**Dauer:** ~3-5 Minuten

**Resultat:** 9 Functions deployed

---

## 5Ô∏è‚É£ CHATGPT GPT KONFIGURIEREN

### 5.1 GPT erstellen

1. Gehen Sie zu https://chat.openai.com/gpts/editor
2. Erstellen Sie einen neuen GPT
3. Name: "Schweizer Krankenkassen Experte"
4. Description: "Offizieller Pr√§mienberater mit BAG-Daten"

### 5.2 Instructions kopieren

1. √ñffnen Sie `GPT_INSTRUCTIONS_FINAL_COMPACT.md`
2. Kopieren Sie den gesamten Inhalt
3. F√ºgen Sie ihn im GPT Builder unter **Instructions** ein

### 5.3 Actions konfigurieren

**Import OpenAPI Schema:**
1. **Actions** ‚Üí **Create new action**
2. **Import from file** ‚Üí W√§hlen Sie `openapi-chatgpt-historical.yaml`

**Authentication:**
1. **Authentication** ‚Üí **API Key**
2. **Auth Type:** Custom
3. **Custom Header Name:** `X-API-Key`
4. **API Key:** Kopieren Sie den Wert aus Ihrer `.env` Datei

### 5.4 Testen

Testen Sie diese Fragen:

1. "Was kostet CSS f√ºr einen Mann, 52, in 8000 Z√ºrich, HMO, ohne Unfallversicherung?"
2. "Zeige mir die g√ºnstigsten 5 Krankenkassen f√ºr Z√ºrich"
3. "Wie hat sich CSS entwickelt die letzten 10 Jahre?"
4. "Vergleiche CSS mit Assura"

**Erwartetes Ergebnis:**
- PLZ-Abfrage funktioniert
- Pr√§mien werden korrekt angezeigt
- Timeline wird berechnet
- Alle Versicherer werden gefunden

---

## 6Ô∏è‚É£ WARTUNG & UPDATES

### J√§hrliche Daten-Updates

Wenn BAG neue Daten ver√∂ffentlicht (normalerweise September):

```bash
# 1. Neue Daten herunterladen
npx tsx scripts/download-bag-data.ts

# 2. Transformieren (Jahr anpassen!)
npx tsx scripts/transform-2026.ts

# 3. Importieren
npx tsx scripts/import-complete-all.ts
```

### Firebase Functions aktualisieren

```bash
cd functions
npm run build
cd ..
firebase deploy --only functions
```

### GPT Instructions aktualisieren

Falls √Ñnderungen an den Instructions n√∂tig sind:
1. Bearbeiten Sie `GPT_INSTRUCTIONS_FINAL_COMPACT.md`
2. Kopieren Sie den neuen Text
3. F√ºgen Sie ihn im GPT Builder ein
4. Speichern

---

## üîç VERIFIZIERUNG

### Datenbank pr√ºfen

```bash
npx tsx -e "
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
dotenv.config();

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

const { count } = await supabase
  .from('premiums')
  .select('*', { count: 'exact', head: true });

console.log('Total Pr√§mien:', count);
"
```

### API testen

```bash
curl "https://krankenkassen.ragit.io/premiums/quote?canton=ZH&age_band=adult&franchise_chf=2500&accident_covered=false&model_type=hmo" \
  -H "X-API-Key: Ihr-API-Key"
```

**Erwartete Antwort:** JSON mit `results` Array

---

## ‚ö†Ô∏è Bekannte Probleme & L√∂sungen

### Problem: "Statement timeout"
**Ursache:** Gro√üe Zeitr√§ume (2016-2026) k√∂nnen langsam sein  
**L√∂sung:** Verk√ºrzen Sie den Zeitraum oder optimieren Sie Indizes

### Problem: "Duplicate key violation"
**Ursache:** Daten wurden schon importiert  
**L√∂sung:** L√∂schen Sie das Jahr zuerst oder verwenden Sie ein neues Jahr

### Problem: "No results found"
**Ursache:** Nicht alle Kombinationen existieren  
**L√∂sung:** Versuchen Sie andere Franchisen oder Modelle

---

## üìû Support

F√ºr technische Fragen:
- Email: support@swisshealth-api.ch
- GitHub Issues (falls √∂ffentlich)

---

**Viel Erfolg mit Ihrem Schweizer Krankenkassen-Experten! üá®üá≠**